### 传统部署模式
#### 生产环境运行程序 使用pm2 - process manager：https://pm2.keymetrics.io/

```shell
# 默认
node script.js
# pm2
pm2 start script.js
```
#### PM2 优势
- cluster模式运行
- 自动重启 auto reload
- 热替换 hot reload
- 性能监控


### pm2

* 进程守护 - 稳定
* 多进程 - 高效
* 日志记录 - 问题可追溯

#### pm2
安装  npm i pm2 -g      
pm2配置 在 bin/ 目录下    
##### 基本使用
* 启动：pm2 start xxx.js
* 重启：pm2 restart <id/name>
* 重载：pm2 reload
* 列表：pm2 list
* 日志：pm2 logs <id/name>
* 停止：pm2 stop <id/name>
* 删除：pm2 delete <id/name>
* 监控：pm2 monit 
```javascript
const os = require('os')
const cpuCoreLength = os.cpus().length // CPU 几核
module.exports = {
apps: [
  {
    name: 'your-server-name',
    script:'bin/www',
    // watch: true，// 无特殊情况，不用实时监听文件，否则可能会导致很多 restart
    ignore_watch: ['node modules','__test__','logs'],
    //instances: cpuCoreLength，// 线上环境，多进程
    instances: 1，// 测试环境，一个进程即可
    error_file:'./logs/err.log',
    out_file: './logs/out.log',
    Log_date_format:'YYYY-MM-DD HH:mm:ss z'，// Z 表示使用当前时区的时间格式
    combine_logs: true，// 多个实例，合并日志
    max_memory_restart:'300M'，// 内存占用超过 300M ，则重启
  }
],
}
```
##### 日志拆分 pm2-logrotate
* 安装插件 - 使用 ​​pm2​​ 进行安装  -  pm2 install pm2-logrotate
* 安装完以后， 通过 ​​pm2 list​​​ 可以查看到 ​​pm2-logrotate​​ 的进程。
* pm2-logrotate 修改 默认设置 pm2 set pm2-logrotate:max_size 10M # 日志最大 10M 等等

### egg.js 中
1. 
- egg-scripts：https://github.com/eggjs/egg-scripts
- egg-cluster https://github.com/eggjs/egg-cluster

2. egg.js生产环境启动和关闭
```shell
egg-scripts start

egg-scripts stop

```

3. 配置文件
config.prod.ts + config.default.ts

1. 执行 npm run tsc 生成 .js文件 后才可以

### egg.js cluster 模型的原理
- Egg.js 关于这部分内容的文档: https://www.eggjs.org/zh-CN/core/cluster-and-ipc
- 为什么要采用 cluster 模式
  JavaScript代码是运行在单线程上的，那么如果用 Node.is 来做 Web Server，就无法享受到多核运算的好处。
- Cluster 是什么呢？
  * 在服务器上同时启动多个进程。
  * 每个进程里都跑的是同一份源代码（好比把以前一个进程的工作分给多个进程去做）。
  * 更神奇的是，这些进程可以同时监听一个端口

### Node.js压力测试工具
Loadtest: https://github.com/alexfernandez/loadtest
```shell
# n 总过发送多少个请求
# c concurrency 同时有几个客户端在发送请求
# rps request per seconds 每秒发送多少个请求
loadtest -n 400 -C 10 --rps 200 http://mysite.com/

```