### 服务器设置以及登录最佳实践 (centos7.6)

#### 用户配置

1. 使用 Git Bash root 帐号登录 - `ssh root@8.134.104.190`
2. 添加用户 `useradd ryan` 删除用户 `userdel -r ryan`
3. 配置用户 设置用户密码 `passwd ryan`
4. `sudoers` - bash: sudoers: 未找到命令...
5. `whereis sudoers`
6. 找到这个文件位置之后再查看权限： `ls -l /etc/sudoers` - -r--r----- 1 root root 4251 9 月 25 15:08 /etc/sudoers - 只有只读的权限
7. `chmod -v u+w /etc/sudoers` - mode of "/etc/sudoers" changed from 0440 (r--r-----) to 0640 (rw-r-----)
8. 然后就可以添加内容了，在下面的一行下追加新增的用户：`vim /etc/sudoers`
9. `i` 进入编辑模式

```shell
## Allow root to run any commands anywher
root    ALL=(ALL)       ALL
ryan    ALL=(ALL)       ALL  #这个是新增的用户
```

10. Esc 键，Vim 进入命令模式。然后输入：

- :q ——退出，这是:quit 的缩写。
- :q!——不保存退出，这是:quit!的缩写。
- :wq——写入文件并退出，这是:writequit 的缩写。
- :wq!——如果文件只有读权限，则写入并退出；如果文件没有写权限，则强制写。
- :x——类似于:wq，如果文件无变动，那就不写入。
- :qa——退出全部，这是:quitall 的缩写。
- ZZ—— （大写的 Z）如果文件有变动，写入/保存，然后退出。
- ZQ—— 如果不想保存文件，就可以用这个命令退出。

11. wq 保存退出，这时候要记得将写权限收回 `chmod -v u-w /etc/sudoers` - mode of "/etc/sudoers" changed from 0640 (rw-r-----) to 0440 (r--r-----)
12. `exit` 退出 - 使用新用户登录 `ssh ryan@8.134.104.190`
13. 使用 sudo 提示输入密码 最后一个 ALL 改为 NOPASSWD:ALL
14. `whoami` 查看用户名 `pwd` 查看空间
15. 使用`su`直接切换为 root 用户 `exit` 退出
16. 也可以使用 sudo 快捷的使用 root 权限进行操作
17. 禁止使用 root 远程登录 ssh
18. `su` 切换到 root
19. 修改 ssh 配置 `vim /etc/ssh/sshd_config` 修改 PermitRootLogin yes 为 no 然后重启 sshd 服务 `service sshd restart`
20. `service sshd status` 查看状态 看启动时间

#### 使用 SSH Key 进行登录

`windows 管理员模式运行 git bash 执行 ssh-copy-id ryan@8.134.104.190`

1. windows C:\Users\Ryan\.ssh 存在无需创建
2. 公钥 id_rsa.pub
3. windows 系统 下面的操作不行：`mkdir .ssh` `cd .ssh`
4. 登陆远程机器`touch authorized_keys`创建文件 `vim authorized_keys` 将 id_rsa.pub 内容粘贴进来

#### 关闭密码登录服务器的功能

1. vim /etc/ssh/sshd_config #修改 ssh 配置
2. PasswordAuthentication no #修改为 no
3. service sshd restart #重启服务

### 安装软件

#### Linux 发行版的两大家族

- Debian(完全免费的 Linux 发行版) Ubuntu (基于 Debian，更加容易上手) -apt 包管理系统-软件格式为 deb 包
- Red Hat (商用 Linux 发行版) -CentOs (Red Hat 减去收费软件) -yum 包管理系统-软件格式为 rpm

```shell
# Using ubuntu

# 添加包管理器的软件源 (PPA)
# /etc/apt/sources.list
# /etc/apt/sources.list.d/

# Using Centos
# 查看 centos 所有的软件源
yum repolist all
```

#### 安装 git

```shell
yum -y install git
# 检测是否安装成功
git --version
```

#### 安装 nvm

https://github.com/nvm-sh/nvm?tab=readme-ov-file#troubleshooting-on-linux

```shell
# 1. 下载安装
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

 # 2.下面代码添加到 ~/.bash_profile
export NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # This loads nvm

# 3. 执行
source ~/.bashrc
```

#### 安装 Redis

源码编译安装

// 进入目录 /usr/local

1. sudo curl -O https://download.redis.io/redis-stable.tar.gz
2. sudo tar -xzvf redis-stable.tar.gz
3. cd redis-stable
4. make
5. sudo make install
6. vim redis.conf

```js
	//让Redis绑定在 0.0.0.0 这个 IP 地址上，表示可以接收任何 IP 地址的连接。
    将bind 127.0.0.1 -::1 替换为 bind 0.0.0.0
    //这个表示支持后台启动
	将 daemonize on 替换成 daemonize yes



    //protected-mode  保护模式,一定要关闭
	将protected yes 改为no
    //Redis运行日志
	日志logfile   “./redis.log”
    //登录密码 建议设置为相同密码维护成本低，不同也可以
	requirepass xxxx  <设置密码>
    masterauth xxxx  <设置密码>
```

7. redis-server ./redis.conf
8. ps aux | grep redis

#### 安装 mongodb

https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-red-hat/

1. 创建.repo 文件，生成 mongodb 的源

```js
// root 用户
vi etc/yum.repos.d/mongodb-org-7.0.repo
// 粘贴 官网 对应版本的 源码 centos7的


[mongodb-org-7.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/7/mongodb-org/7.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-7.0.asc

// 解释
name         # 名称
baseurl      # 获得下载的路径
gpkcheck=1   # 表示对从这个源下载的rpm包进行校验；
enable=1     # 表示启用这个源。
gpgkey       # gpg验证


```

2. 使用 yum 安装 MongoDB
   ```js
   sudo yum install -y mongodb-org
   ```
3. 验证安装结果
   ```js
   rpm -qa |grep mongodb
   rpm -ql mongodb-org-server
   ```
4. 启动 MongoDB
   ```js
   systemctl start mongod.service
   // 查看状态
   service mongod status
   // MongoDB默认端口是27017，查看是否开启
   netstat -natp | grep 27017
   // 检查数据库是否安装成功
   ps -aux | grep mongod    # 查看数据库的进程是否存在
   //  验证服务开启
   mongosh
   ```
5. 常用命令清单

   ```js
   // 1、开启MongoDB
   sudo service mongod start  或者 systemctl start mongod.service  # 开启MongoDB
   sudo chkconfig mongod on  # 加入开机启动
   sudo service mongod restart # 重启MongoDB
   // 2、关闭 MongoDB
   sudo service mongod stop # 关闭防火墙

    // 3、卸载 MongoDB
    sudo yum erase $(rpm -qa | grep mongodb-org) # 卸载 MongoDB
    sudo rm -r /var/log/mongodb # 删除日志文件
    sudo rm -r /var/lib/mongo # 删除数据文件
   ```

6. 远程连接 Mongodb

   ```js
   // 修改配置文件mongodb.conf
   vi /etc/mongod.conf

    # network interfaces
    net:
    port: 27017
    bindIp: 0.0.0.0  # Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.

    // 修改绑定ip默认127.0.0.1只允许本地连接， 所以修改为bindIp:0.0.0.0, 退出保存
    // 重启mongodb服务
    sudo service mongod restart

   ```

   开放对外端口

   ```
   方法一
   systemctl status firewalld  # 查看防火墙状态
    firewall-cmd --zone=public --add-port=27017/tcp --permanent # mongodb默认端口号
    firewall-cmd --reload  # 重新加载防火墙

    firewall-cmd --zone=public --query-port=27017/tcp # 查看端口号是否开放成功，输出yes开放成功，no则失败

    方法二
    iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 27017 -j ACCEPT

   ```

7. 远程连接

   ```js
   // 默认连接
   mongo 10.128.218.14:27017
   // 连接到自定义的用户
   // 1. 创建用户，设置账号，密码，权限
   // admin数据库
    > use admin
    switched to db admin
    > db.createUser({ user:"root", pwd:"123456", roles:["root"] })
    Successfully added user: { "user" : "root", "roles" : [ "root" ] }

    // 其他数据库
    > use test
    switched to db test
    > db.createUser({ user:"admin", pwd:"123456", roles:["readWrite", "dbAdmin"] })
    Successfully added user: { "user" : "root", "roles" : [ "root" ] }

    // 2.修改mongodb.conf文件，启用身份验证
    vi /etc/mongod.conf

    security:
    authorization: "enabled"   # disable or enabled

    // 3. 重启MongoDB
    sudo service mongod restart
    // 4. 用户认证
    > use admin
    switched to db admin
    > db.auth("root", "123456")
    1 // 授权成功

    // 其他常用命令
    db.updateUser(user, writeConcern) # 更新用户
    db.dropUser('test') # 删除用户

    // 远程连接
    // 终端连接
    mongo 10.128.218.14:27017/database -u username -p password

    // mongoose方式连接
    mongoose.connect('mongodb://username:password@host:port/database?options...', {useNewUrlParser: true});

    // 通过客户端连接

   ```

用户权限角色说明

| 规则                 | 说明                                                                                |
| -------------------- | ----------------------------------------------------------------------------------- |
| root                 | 只在 admin 数据库中可用。超级账号，超级权限                                         |
| Read                 | 允许用户读取指定数据库                                                              |
| readWrite            | 允许用户读写指定数据库                                                              |
| dbAdmin              | 允许用户在指定数据库中执行管理函数，如索引创建、删除，查看统计或访问 system.profile |
| userAdmin            | 允许用户向 system.users 集合写入，可以找指定数据库里创建、删除和管理用户            |
| clusterAdmin         | 只在 admin 数据库中可用，赋予用户所有分片和复制集相关函数的管理权限                 |
| readAnyDatabase      | 只在 admin 数据库中可用，赋予用户所有数据库的读权限                                 |
| readWriteAnyDatabase | 只在 admin 数据库中可用，赋予用户所有数据库的读写权限                               |
| userAdminAnyDatabase | 只在 admin 数据库中可用，赋予用户所有数据库的 userAdmin 权限                        |
| dbAdminAnyDatabase   | 只在 admin 数据库中可用，赋予用户所有数据库的 dbAdmin 权限                          |
